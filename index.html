<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shift Hours Tracker (WhatsApp Paste + OCR Import)</title>

  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <!-- PDF.js (render PDF to canvas for OCR) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>

 

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; max-width: 1100px; }
    h1 { margin: 0 0 6px; font-size: 22px; text-align:center; color: #d33; }
    .muted { color: #666; font-size: 13px; }
    .grid { display: grid; gap: 12px; }
    @media (min-width: 980px) { .grid { grid-template-columns: 1.2fr 1fr; } }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; }
    label { display:block; margin: 8px 0 4px; font-size: 13px; }
    input, select, button, textarea {
      width: 100%; padding: 10px; font-size: 14px; border-radius: 10px; border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea { min-height: 110px; resize: vertical; }
    .row { display:flex; gap: 10px; }
    .row > div { flex: 1; }
    button { cursor:pointer; }
    .btn { border: 1px solid #ccc; background: #fff; }
    .btn.primary { border-color: #2b6; }
    .btn.danger { border-color: #d33; }
    .btn.small { padding: 7px 10px; font-size: 13px; border-radius: 9px; width: auto; }
    .btn.inline { width: auto; }
    .pill { display:inline-block; padding: 4px 8px; border: 1px solid #ccc; border-radius: 999px; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; font-size: 13px; vertical-align: top; }
    th { font-weight: 600; }
    .right { text-align:right; }
    .controls { display:flex; gap: 10px; flex-wrap: wrap; align-items: end; }
    .controls > * { flex: 1; min-width: 180px; }
    .kpi { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    .kpi .box { flex: 1; min-width: 220px; border: 1px solid #e6e6e6; border-radius: 12px; padding: 10px; }
    .kpi .label { font-size: 12px; color: #666; }
    .kpi .value { font-size: 18px; font-weight: 700; margin-top: 4px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .footer { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .footer button { flex: 1; min-width: 200px; }
    .warn { color: #b36b00; font-size: 13px; margin-top: 8px; white-space: pre-line; }
    .ok { color: #1a7f37; font-size: 13px; margin-top: 8px; }

    /* Modal */
    .modalBack {
      position: fixed; inset: 0; background: rgba(0,0,0,.35);
      display: none; align-items: center; justify-content: center; padding: 14px;
    }
    .modal {
      width: min(980px, 100%);
      background: #fff;
      border-radius: 14px;
      border: 1px solid #ddd;
      padding: 12px;
      max-height: 90vh;
      overflow: auto;
    }
    .modalHeader { display:flex; justify-content: space-between; align-items:center; gap: 10px; }
    .tabs { display:flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .tab { padding: 8px 10px; border: 1px solid #ccc; border-radius: 999px; cursor:pointer; }
    .tab.active { border-color: #2b6; }
    .section { display:none; margin-top: 10px; }
    .section.active { display:block; }
    .smallnote { font-size: 12px; color:#666; margin-top: 6px; }
    .spinner { display:none; margin-top: 10px; }
    .spinner.show { display:block; }
    .previewWrap { margin-top: 10px; }
    .previewWrap table input { padding: 6px; font-size: 13px; border-radius: 8px; }
  </style>
</head>

<body>
  <h1>Shift Hours Tracker</h1>
  <div class="muted">
    Offline-first browser app (auto-saves). Import: Paste WhatsApp text or Upload PDF/JPG â†’ OCR â†’ Preview â†’ Save.
    âœ… Future dates blocked. âœ… Header lines like "Osterley February 2026" are auto-detected and skipped.
  </div>

  <div class="grid" style="margin-top: 12px;">
    <!-- LEFT -->
    <div class="card">
      <div class="controls">
        <div>
          <label>Selected date (no future dates)</label>
          <input id="selectedDate" type="date" />
          <div id="dateMsg" class="warn" style="display:none;">You canâ€™t select a higher date.</div>
        </div>

        <div>
          <label>Location / Site</label>
          <input id="location" type="text" placeholder="e.g., Harrow / Osterley" />
        </div>

        <div>
          <label>&nbsp;</label>
          <button class="btn" onclick="openImport()">Import (Paste / PDF / JPG)</button>
        </div>
      </div>

      <div class="kpi">
        <div class="box">
          <div class="label">Daily total (selected date)</div>
          <div class="value"><span id="dailyTotal">0.00</span> hrs</div>
        </div>
        <div class="box">
          <div class="label">All dates total</div>
          <div class="value"><span id="allTotal">0.00</span> hrs</div>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid #eee;margin:12px 0;" />

      <div class="row">
        <div>
          <label>Employee name</label>
          <input id="employee" type="text" placeholder="e.g., Kiran" />
        </div>
        <div>
          <label>Break (minutes)</label>
          <input id="breakMin" type="number" min="0" step="5" value="0" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Start time</label>
          <input id="startTime" type="time" />
        </div>
        <div>
          <label>End time</label>
          <input id="endTime" type="time" />
        </div>
      </div>

      <label>Notes (optional)</label>
      <input id="notes" type="text" placeholder="Optional notes" />

      <div class="kpi">
        <div class="box">
          <div class="label">Calculated hours (preview)</div>
          <div class="value"><span id="previewHours">0.00</span> hrs</div>
          <div class="muted">Overnight supported (e.g., 17:00 â†’ 03:30)</div>
          <div id="previewWarn" class="warn" style="display:none;"></div>
        </div>
      </div>

      <div class="footer">
        <button id="addBtn" class="btn primary" onclick="addShift()">Add shift</button>
        <button class="btn" onclick="exportCSV()">Export CSV (all)</button>
        <button class="btn danger" onclick="clearAll()">Clear all data</button>
      </div>

      <hr style="border:none;border-top:1px solid #eee;margin:12px 0;" />

      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div style="font-weight:700;">Shifts for selected date</div>
        <span class="pill">Saved entries: <span id="countAll">0</span></span>
      </div>

      <table>
        <thead>
          <tr>
            <th>Employee</th>
            <th>Location</th>
            <th>Start â†’ End</th>
            <th class="right">Hours</th>
            <th class="right">Actions</th>
          </tr>
        </thead>
        <tbody id="dailyTable"></tbody>
      </table>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div style="font-weight:700;">Totals by date</div>
      <div class="muted">Click a date row to jump the selector.</div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th class="right">Total hrs</th>
            <th class="right">Entries</th>
          </tr>
        </thead>
        <tbody id="byDateTable"></tbody>
      </table>

      <hr style="border:none;border-top:1px solid #eee;margin:12px 0;" />

      <div style="font-weight:700;">Employees</div>
      <div class="muted">Choose an employee to view all shifts across all dates.</div>

      <label>Choose employee</label>
      <select id="employeeSelect" onchange="renderEmployeeDetail()">
        <option value="">â€” Select â€”</option>
      </select>

      <div class="kpi">
        <div class="box">
          <div class="label">Selected employee total (all dates)</div>
          <div class="value"><span id="empTotal">0.00</span> hrs</div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Location</th>
            <th>Start â†’ End</th>
            <th class="right">Hours</th>
          </tr>
        </thead>
        <tbody id="employeeTable"></tbody>
      </table>
    </div>
  </div>

  <!-- IMPORT MODAL -->
  <div id="modalBack" class="modalBack">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <div style="font-weight:800;">Import shifts</div>
          <div class="muted">Paste text OR upload PDF/JPG â†’ OCR â†’ preview table â†’ save.</div>
        </div>
        <button class="btn inline" onclick="closeImport()">Close</button>
      </div>

      <div class="tabs">
        <div id="tabPaste" class="tab active" onclick="switchTab('paste')">ðŸ“‹ Paste text</div>
        <div id="tabUpload" class="tab" onclick="switchTab('upload')">ðŸ“„ Upload PDF/JPG</div>
      </div>

      <!-- Defaults for parsing -->
      <div class="row" style="margin-top:10px;">
        <div>
          <label>Default month (for dates like 7/2)</label>
          <select id="defaultMonth">
            <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option>
            <option value="5">May</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Aug</option>
            <option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
          </select>
          <div class="smallnote">UK format assumed: 7/2 = 7 Feb.</div>
        </div>
        <div>
          <label>Default year</label>
          <input id="defaultYear" type="number" min="2000" max="2100" />
          <div class="smallnote">If text has no year, we use this.</div>
        </div>
        <div>
          <label>Default location (optional)</label>
          <input id="defaultLocationImport" type="text" placeholder="e.g., Osterley" />
          <div class="smallnote">Used when import lines donâ€™t include location.</div>
        </div>
      </div>

      <div class="ok" id="autoDetected" style="display:none;"></div>

      <!-- Paste section -->
      <div id="sectionPaste" class="section active">
        <label>Paste your shift notes</label>
        <textarea id="pasteText" placeholder="Example:
Osterley February 2026
1/2
Simran 6pm to 12
..."></textarea>

        <div class="row">
          <div><button class="btn primary" onclick="parseFromPaste()">Parse â†’ Preview</button></div>
          <div><button class="btn" onclick="clearImportDraft()">Clear</button></div>
        </div>

        <div id="pasteWarn" class="warn" style="display:none;"></div>
      </div>

      <!-- Upload section -->
      <div id="sectionUpload" class="section">
        <label>Upload PDF or Image (JPG/PNG)</label>
        <input id="uploadFile" type="file" accept=".pdf,image/*" />

        <div class="row">
          <div><button class="btn primary" onclick="ocrFromUpload()">Run OCR â†’ Preview</button></div>
          <div><button class="btn" onclick="clearImportDraft()">Clear</button></div>
        </div>

        <div class="smallnote">
          â€¢ Plain text images work fine (no table required).<br/>
          â€¢ PDFs: we OCR up to <b>3 pages</b> to keep it simple.
        </div>

        <div id="ocrStatus" class="spinner"></div>
        <div id="uploadWarn" class="warn" style="display:none;"></div>
      </div>

      <!-- OCR output + Preview -->
      <div class="previewWrap">
        <label>Extracted text (from OCR or paste)</label>
        <textarea id="extractedText" placeholder="Extracted text will appear here..."></textarea>

        <div class="row">
          <div><button class="btn primary" onclick="parseFromExtracted()">Parse Extracted Text â†’ Preview</button></div>
          <div><button class="btn" onclick="copyExtracted()">Copy extracted text</button></div>
        </div>

        <div id="parseWarn" class="warn" style="display:none;"></div>
        <div id="parseOk" class="ok" style="display:none;"></div>

        <div id="previewArea"></div>

        <div class="footer">
          <button class="btn primary" onclick="saveImported()">Save imported shifts</button>
          <button class="btn" onclick="closeImport()">Done</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Storage (JSON)
========================= */
const STORAGE_KEY = "shift_hours_tracker_v6_whatsapp";
let shifts = load();
function load() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); } catch { return []; } }
function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(shifts)); }

/* =========================
   Date checks (no future)
========================= */
function todayISO() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}
function isFutureDate(dateStr) { return !!dateStr && dateStr > todayISO(); }
function showDateMsg(show) { document.getElementById("dateMsg").style.display = show ? "block" : "none"; }

/* =========================
   Time helpers
========================= */
function toMinutes(hhmm) {
  const [h, m] = hhmm.split(":").map(Number);
  return h * 60 + m;
}
function durationMinutes(startHHMM, endHHMM) {
  let s = toMinutes(startHHMM);
  let e = toMinutes(endHHMM);
  if (e < s) e += 24 * 60;
  return e - s;
}
function calcHours(startHHMM, endHHMM, breakMin) {
  const dur = durationMinutes(startHHMM, endHHMM);
  const net = dur - Number(breakMin || 0);
  if (net <= 0) return 0;
  return net / 60;
}
function round2(x) { return Math.round(x * 100) / 100; }

/* =========================
   Validation
========================= */
function validateShift(start, end, breakMin) {
  if (!start || !end) return { ok:false, message:"Start and End time are required." };
  const dur = durationMinutes(start, end);
  const net = dur - Number(breakMin || 0);
  if (dur === 0) return { ok:false, message:"Start and End time cannot be the same." };
  if (net <= 0) return { ok:false, message:"Break minutes cannot be equal to or greater than total shift time." };
  if (net > 16 * 60) return { ok:true, warn:"This shift is longer than 16 hours. Please double-check." };
  return { ok:true };
}

/* =========================
   Aggregations
========================= */
function shiftsForDate(dateStr) { return shifts.filter(s => s.date === dateStr); }
function totalHoursForDate(dateStr) { return round2(shiftsForDate(dateStr).reduce((sum, s) => sum + s.hours, 0)); }
function allHoursTotal() { return round2(shifts.reduce((sum, s) => sum + s.hours, 0)); }
function totalsByDate() {
  const map = new Map();
  for (const s of shifts) {
    const cur = map.get(s.date) || { total: 0, count: 0 };
    cur.total += s.hours; cur.count += 1; map.set(s.date, cur);
  }
  return [...map.entries()].sort((a,b) => a[0].localeCompare(b[0]))
    .map(([date,v]) => ({ date, total: round2(v.total), count: v.count }));
}
function totalsByEmployee() {
  const map = new Map();
  for (const s of shifts) map.set(s.employee, (map.get(s.employee)||0) + s.hours);
  return [...map.entries()].map(([employee,total]) => ({ employee, total: round2(total) }))
    .sort((a,b) => a.employee.localeCompare(b.employee));
}
function shiftsByEmployee(employeeName) {
  return shifts.filter(s => s.employee === employeeName)
    .sort((a,b) => (a.date + a.start).localeCompare(b.date + b.start));
}

/* =========================
   Render UI
========================= */
function render() {
  const selectedDate = document.getElementById("selectedDate").value;

  document.getElementById("countAll").innerText = String(shifts.length);
  document.getElementById("dailyTotal").innerText = totalHoursForDate(selectedDate).toFixed(2);
  document.getElementById("allTotal").innerText = allHoursTotal().toFixed(2);

  // Daily table
  const daily = shiftsForDate(selectedDate).sort((a,b) => a.start.localeCompare(b.start));
  const dailyBody = document.getElementById("dailyTable");
  dailyBody.innerHTML = "";
  if (daily.length === 0) {
    dailyBody.innerHTML = `<tr><td colspan="5" class="muted">No shifts for this date.</td></tr>`;
  } else {
    for (const s of daily) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(s.employee)}</td>
        <td>${escapeHtml(s.location||"")}</td>
        <td class="mono">${s.start} â†’ ${s.end}${s.breakMin ? ` <span class="muted">(break ${s.breakMin}m)</span>` : ""}</td>
        <td class="right mono">${s.hours.toFixed(2)}</td>
        <td class="right">
          <button class="btn small" onclick="editShift('${s.id}')">Edit</button>
          <button class="btn small danger" onclick="deleteShift('${s.id}')">Delete</button>
        </td>
      `;
      dailyBody.appendChild(tr);
    }
  }

  // By date
  const byDate = totalsByDate();
  const byDateBody = document.getElementById("byDateTable");
  byDateBody.innerHTML = "";
  if (byDate.length === 0) {
    byDateBody.innerHTML = `<tr><td colspan="3" class="muted">No data yet.</td></tr>`;
  } else {
    for (const row of byDate) {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.onclick = () => { document.getElementById("selectedDate").value = row.date; render(); };
      tr.innerHTML = `
        <td class="mono">${row.date}</td>
        <td class="right mono">${row.total.toFixed(2)}</td>
        <td class="right mono">${row.count}</td>
      `;
      byDateBody.appendChild(tr);
    }
  }

  // Employees
  const empSelect = document.getElementById("employeeSelect");
  const current = empSelect.value;
  const emps = totalsByEmployee();
  empSelect.innerHTML = `<option value="">â€” Select â€”</option>` + emps
    .map(e => `<option value="${escapeAttr(e.employee)}">${escapeHtml(e.employee)} (${e.total.toFixed(2)}h)</option>`).join("");
  if (emps.some(e => e.employee === current)) empSelect.value = current;

  renderEmployeeDetail();
}
function renderEmployeeDetail() {
  const emp = document.getElementById("employeeSelect").value;
  const body = document.getElementById("employeeTable");
  const totalEl = document.getElementById("empTotal");
  body.innerHTML = "";

  if (!emp) {
    totalEl.innerText = "0.00";
    body.innerHTML = `<tr><td colspan="4" class="muted">Select an employee to view details.</td></tr>`;
    return;
  }

  const list = shiftsByEmployee(emp);
  totalEl.innerText = round2(list.reduce((sum,s)=>sum+s.hours,0)).toFixed(2);

  if (list.length === 0) {
    body.innerHTML = `<tr><td colspan="4" class="muted">No shifts found for this employee.</td></tr>`;
    return;
  }
  for (const s of list) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${s.date}</td>
      <td>${escapeHtml(s.location||"")}</td>
      <td class="mono">${s.start} â†’ ${s.end}${s.breakMin ? ` <span class="muted">(break ${s.breakMin}m)</span>` : ""}</td>
      <td class="right mono">${s.hours.toFixed(2)}</td>
    `;
    body.appendChild(tr);
  }
}

/* =========================
   CRUD
========================= */
function addShift() {
  const date = document.getElementById("selectedDate").value;

  if (isFutureDate(date)) {
    showDateMsg(true);
    alert("You canâ€™t select a higher date.");
    document.getElementById("selectedDate").value = todayISO();
    render();
    return;
  }
  showDateMsg(false);

  const location = document.getElementById("location").value.trim();
  const employee = document.getElementById("employee").value.trim();
  const start = document.getElementById("startTime").value;
  const end = document.getElementById("endTime").value;
  const breakMin = Number(document.getElementById("breakMin").value || 0);
  const notes = document.getElementById("notes").value.trim();

  if (!date || !employee || !start || !end) {
    alert("Please fill: date, employee, start time, end time.");
    return;
  }

  const v = validateShift(start, end, breakMin);
  if (!v.ok) { alert(v.message); return; }

  const hours = round2(calcHours(start, end, breakMin));
  shifts.push({ id: makeId(), date, location, employee, start, end, breakMin, notes, hours });
  save();
  resetAddButton();
  clearEntryFields();
  render();
}

function editShift(id) {
  const s = shifts.find(x => x.id === id);
  if (!s) return;

  document.getElementById("selectedDate").value = s.date;
  document.getElementById("location").value = s.location || "";
  document.getElementById("employee").value = s.employee;
  document.getElementById("startTime").value = s.start;
  document.getElementById("endTime").value = s.end;
  document.getElementById("breakMin").value = String(s.breakMin || 0);
  document.getElementById("notes").value = s.notes || "";

  const btn = document.getElementById("addBtn");
  btn.textContent = "Save changes";
  btn.onclick = () => saveEdit(id);
  updatePreview();
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function saveEdit(id) {
  const idx = shifts.findIndex(x => x.id === id);
  if (idx === -1) return;

  const date = document.getElementById("selectedDate").value;
  if (isFutureDate(date)) {
    showDateMsg(true);
    alert("You canâ€™t select a higher date.");
    document.getElementById("selectedDate").value = todayISO();
    render();
    return;
  }
  showDateMsg(false);

  const location = document.getElementById("location").value.trim();
  const employee = document.getElementById("employee").value.trim();
  const start = document.getElementById("startTime").value;
  const end = document.getElementById("endTime").value;
  const breakMin = Number(document.getElementById("breakMin").value || 0);
  const notes = document.getElementById("notes").value.trim();

  if (!date || !employee || !start || !end) {
    alert("Please fill: date, employee, start time, end time.");
    return;
  }

  const v = validateShift(start, end, breakMin);
  if (!v.ok) { alert(v.message); return; }

  const hours = round2(calcHours(start, end, breakMin));
  shifts[idx] = { ...shifts[idx], date, location, employee, start, end, breakMin, notes, hours };
  save();
  resetAddButton();
  clearEntryFields();
  render();
}

function deleteShift(id) {
  if (!confirm("Delete this shift?")) return;
  shifts = shifts.filter(s => s.id !== id);
  save();
  render();
}

function clearAll() {
  if (!confirm("This will delete ALL saved shifts from this browser. Continue?")) return;
  shifts = [];
  save();
  resetAddButton();
  clearEntryFields();
  render();
}

function resetAddButton() {
  const btn = document.getElementById("addBtn");
  btn.textContent = "Add shift";
  btn.onclick = addShift;
}

function clearEntryFields() {
  document.getElementById("employee").value = "";
  document.getElementById("startTime").value = "";
  document.getElementById("endTime").value = "";
  document.getElementById("breakMin").value = "0";
  document.getElementById("notes").value = "";
  updatePreview();
}

/* =========================
   Preview calc
========================= */
function updatePreview() {
  const start = document.getElementById("startTime").value;
  const end = document.getElementById("endTime").value;
  const breakMin = Number(document.getElementById("breakMin").value || 0);

  const warnEl = document.getElementById("previewWarn");
  warnEl.style.display = "none";
  warnEl.textContent = "";

  if (!start || !end) {
    document.getElementById("previewHours").innerText = "0.00";
    return;
  }

  const v = validateShift(start, end, breakMin);
  if (!v.ok) {
    document.getElementById("previewHours").innerText = "0.00";
    warnEl.style.display = "block";
    warnEl.textContent = v.message;
    return;
  }
  const h = round2(calcHours(start, end, breakMin));
  document.getElementById("previewHours").innerText = h.toFixed(2);

  if (v.warn) {
    warnEl.style.display = "block";
    warnEl.textContent = v.warn;
  }
}

/* =========================
   Export CSV
========================= */

function exportCSV() {
  if (!shifts || shifts.length === 0) {
    alert("No data found. Import and click 'Save imported shifts' first.");
    return;
  }

  const header = ["date","location","employee","start","end","breakMin","hours","notes"];
  const rows = shifts.slice()
    .sort((a,b) => (a.date + a.employee + a.start).localeCompare(b.date + b.employee + b.start))
    .map(s => [
      s.date,
      s.location || "",
      s.employee,
      s.start,
      s.end,
      String(s.breakMin || 0),
      Number(s.hours || 0).toFixed(2),
      (s.notes || "").replace(/\r?\n/g," ")
    ]);

  const csv = [header, ...rows].map(r => r.map(csvCell).join(",")).join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `shifts-${todayISO()}.csv`;
  a.click();

  URL.revokeObjectURL(url);
}


/* =========================
   Import Modal (Paste / OCR)
========================= */
let importDraft = [];

function openImport() {
  document.getElementById("modalBack").style.display = "flex";
  const sel = document.getElementById("selectedDate").value || todayISO();
  const [y,m] = sel.split("-").map(Number);
  document.getElementById("defaultYear").value = y;
  document.getElementById("defaultMonth").value = String(m);
  document.getElementById("defaultLocationImport").value = document.getElementById("location").value.trim();
  setText("autoDetected","",false);
}
function closeImport() {
  const back = document.getElementById("modalBack");
  back.style.display = "none";

   // extra safety: remove any stuck pointer blocking
  back.style.pointerEvents = "none"; // unblock page clicks
  setTimeout(() => back.style.pointerEvents = "auto", 0);
}


function switchTab(which) {
  document.getElementById("tabPaste").classList.toggle("active", which==="paste");
  document.getElementById("tabUpload").classList.toggle("active", which==="upload");
  document.getElementById("sectionPaste").classList.toggle("active", which==="paste");
  document.getElementById("sectionUpload").classList.toggle("active", which==="upload");
}
function clearImportDraft() {
  importDraft = [];
  document.getElementById("pasteText").value = "";
  document.getElementById("extractedText").value = "";
  document.getElementById("previewArea").innerHTML = "";
  setText("parseWarn","",false);
  setText("parseOk","",false);
  setText("pasteWarn","",false);
  setText("uploadWarn","",false);
  setText("autoDetected","",false);
  setSpinner(false,"");
}
function copyExtracted() {
  const t = document.getElementById("extractedText").value;
  navigator.clipboard?.writeText(t);
  alert("Copied extracted text.");
}

function parseFromPaste() {
  const txt = document.getElementById("pasteText").value.trim();
  if (!txt) { setText("pasteWarn","Paste some text first.",true); return; }
  setText("pasteWarn","",false);
  document.getElementById("extractedText").value = txt;
  parseFromExtracted();
}

function parseFromExtracted() {
  const txt = document.getElementById("extractedText").value.trim();
  if (!txt) { setText("parseWarn","No text to parse.",true); return; }

  // Auto-detect month/year/location from first few lines
  const det = detectMonthYearFromText(txt);
  if (det) {
    document.getElementById("defaultMonth").value = String(det.month);
    document.getElementById("defaultYear").value = String(det.year);
    if (det.locationGuess && !document.getElementById("defaultLocationImport").value.trim()) {
      document.getElementById("defaultLocationImport").value = det.locationGuess;
    }
    setText("autoDetected", `Auto-detected: ${det.monthName} ${det.year}` + (det.locationGuess ? ` â€¢ Location: ${det.locationGuess}` : ""), true);
  } else {
    setText("autoDetected","",false);
  }

  const defYear = Number(document.getElementById("defaultYear").value || new Date().getFullYear());
  const defMonth = Number(document.getElementById("defaultMonth").value || (new Date().getMonth()+1));
  const defLoc = document.getElementById("defaultLocationImport").value.trim();

  const result = parseShiftsFromText(txt, defYear, defMonth, defLoc);

  importDraft = result.shifts;
  renderImportPreview(importDraft, result.warnings);

  if (importDraft.length === 0) {
    setText("parseOk","",false);
    setText("parseWarn","No shifts detected. Tip: Put date line like '1/2' then shifts.", true);
  } else {
    setText("parseWarn","",false);
    setText("parseOk", `Parsed ${importDraft.length} shift(s). Warnings: ${result.warnings.length}. Please review before saving.`, true);
  }
}

async function ocrFromUpload() {
  const fileInput = document.getElementById("uploadFile");
  const file = fileInput.files?.[0];
  if (!file) { setText("uploadWarn","Please choose a PDF or image file first.",true); return; }
  setText("uploadWarn","",false);

  const isPDF = file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf");

  try {
    setSpinner(true, "Running OCRâ€¦ this can take a bit.");
    let fullText = "";

    if (!isPDF) {
      fullText = await ocrImageFile(file);
    } else {
      fullText = await ocrPdfFile(file, 3);
    }

    document.getElementById("extractedText").value = fullText.trim();
    setSpinner(false, "OCR complete.");
    parseFromExtracted();
  } catch (err) {
    console.error(err);
    setSpinner(false, "");
    setText("uploadWarn", "OCR failed. Try a clearer image/PDF or paste text instead.", true);
  }
}

async function ocrImageFile(file) {
  const imgURL = URL.createObjectURL(file);
  try {
    const { data } = await Tesseract.recognize(imgURL, "eng", {
      logger: m => setSpinner(true, `OCR: ${m.status} ${m.progress ? Math.round(m.progress*100)+'%' : ''}`)
    });
    return data.text || "";
  } finally { URL.revokeObjectURL(imgURL); }
}

async function ocrPdfFile(file, maxPages=3) {
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";

  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

  const pagesToDo = Math.min(pdf.numPages, maxPages);
  let fullText = "";

  for (let p = 1; p <= pagesToDo; p++) {
    setSpinner(true, `Rendering PDF page ${p}/${pagesToDo}â€¦`);
    const page = await pdf.getPage(p);

    const viewport = page.getViewport({ scale: 2.0 });
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({ canvasContext: ctx, viewport }).promise;

    const imgDataUrl = canvas.toDataURL("image/png");
    setSpinner(true, `OCR page ${p}/${pagesToDo}â€¦`);
    const { data } = await Tesseract.recognize(imgDataUrl, "eng", {
      logger: m => setSpinner(true, `OCR page ${p}: ${m.status} ${m.progress ? Math.round(m.progress*100)+'%' : ''}`)
    });
    fullText += "\n" + (data.text || "");
  }
  return fullText;
}

/* =========================
   Auto detect Month/Year/Location
========================= */
function detectMonthYearFromText(text) {
  const monthMap = {
    january:1, jan:1, february:2, feb:2, march:3, mar:3, april:4, apr:4,
    may:5, june:6, jun:6, july:7, jul:7, august:8, aug:8,
    september:9, sept:9, sep:9, october:10, oct:10, november:11, nov:11, december:12, dec:12
  };
  const monthNames = ["","January","February","March","April","May","June","July","August","September","October","November","December"];

  const sample = text.split(/\r?\n/).slice(0, 8).join(" ").toLowerCase();

  const m = sample.match(/\b(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:t|tember)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\b[^0-9]{0,12}\b(20\d{2}|19\d{2})\b/);
  if (!m) return null;

  const monStr = m[1];
  const year = Number(m[2]);
  const month = monthMap[monStr] || monthMap[monStr.slice(0,3)] || null;
  if (!month) return null;

  // Guess location from first word(s) before month
  let locationGuess = null;
  const locMatch = sample.match(/^([a-z][a-z\s'.-]{2,40}?)\s+(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/);
  if (locMatch) locationGuess = locMatch[1].trim().replace(/\s+/g, " ");

  return { month, year, monthName: monthNames[month], locationGuess };
}

function toISODate(y, m, d) {
  const yy = String(y).padStart(4, "0");
  const mm = String(m).padStart(2, "0");
  const dd = String(d).padStart(2, "0");
  return `${yy}-${mm}-${dd}`;
}

/* =========================================================
   âœ… REQUIRED FUNCTIONS (exactly as you asked)
========================================================= */

function parseShiftsFromText(text, defaultYear, defaultMonth, defaultLocation) {
  const warnings = [];
  const lines = text
    .replace(/\t/g, " ")
    .replace(/[â€“â€”]/g, "-")
    .split(/\r?\n/)
    .map(l => l.trim())
    .filter(Boolean);

  let currentDate = null;         // YYYY-MM-DD
  let dayDefaultAp = null;        // "pm" or "am" inferred from earlier lines in same date
  const parsed = [];

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // âœ… 1) Skip totals lines
    if (/^total\s*hours?\b/i.test(line) || /^hours?\b/i.test(line)) continue;

    // âœ… 2) If it's a header like "Osterley February 2026", detect month/year + skip parsing as shift
    const det = detectMonthYearFromText(line);
    if (det) {
      // Update defaults for following date lines like "1/2"
      defaultMonth = det.month;
      defaultYear = det.year;
      if (det.locationGuess && !defaultLocation) defaultLocation = det.locationGuess;
      continue; // IMPORTANT: do NOT parse this as a shift
    }

    // âœ… 3) Date line: "1/2" or "01/02/2026"
    const dateOnly = line.match(/^(\d{1,2})\s*[\/\-]\s*(\d{1,2})(?:\s*[\/\-]\s*(\d{2,4}))?$/);
    if (dateOnly) {
      const day = Number(dateOnly[1]);
      const month = Number(dateOnly[2]) || defaultMonth;
      let year = dateOnly[3] ? Number(dateOnly[3]) : defaultYear;
      if (year < 100) year = 2000 + year;
      currentDate = toISODate(year, month, day);
      dayDefaultAp = null; // reset per new date
      continue;
    }

    // Extract shift lines with "pm context"
    const extracted = extractShiftsFromLine(line, currentDate, defaultYear, defaultMonth, defaultLocation, dayDefaultAp);

    parsed.push(...extracted.items);
    extracted.warnings.forEach(w => warnings.push(`Line ${i + 1}: ${w}`));

    // âœ… If we saw explicit/inferred pm in this line, keep it for next lines
    if (extracted.dayDefaultAp) dayDefaultAp = extracted.dayDefaultAp;
  }

  parsed.forEach((s, idx) => {
    if (!s.date) warnings.push(`Row ${idx + 1}: Missing date (put a date line like "1/2" before shifts).`);
  });

  return { shifts: parsed, warnings };
}

function extractShiftsFromLine(line, currentDate, defaultYear, defaultMonth, defaultLocation, dayDefaultAp) {
  const warnings = [];
  const items = [];

  // Remove "Hours 30" anywhere in line
  const clean = line.replace(/\bHours?\b\s*\d+(\.\d+)?/gi, "").trim();
  if (!clean) return { items, warnings, dayDefaultAp };

  // âœ… Hard skip: lines that look like month/year headers (extra safety)
  if (detectMonthYearFromText(clean)) {
    return { items, warnings, dayDefaultAp };
  }

  // Only parse if line contains "to" or "-" OR clearly has 2 time tokens with : or am/pm
  const hasToOrDash = /\bto\b|-/i.test(clean);

  const parts = clean.split(/[;|]/).map(s => s.trim()).filter(Boolean);

  for (const part of parts) {
    const m = part.match(/^([A-Za-z][A-Za-z\s'.-]{1,40}?)\s+(.+)$/);
    if (!m) continue;

    const name = m[1].trim();
    const rest = m[2].trim();

    let startRaw = "";
    let endRaw = "";

    // Preferred: "to" or "-"
    let range = rest.match(/(.+?)\s*(?:\bto\b|-)\s*(.+)$/i);
    if (range) {
      startRaw = range[1].trim();
      endRaw = range[2].trim();
    } else {
      // âœ… Missing "to": only accept time tokens that include ":" OR am/pm
      // (This prevents "2026" -> "20" "26" from being treated as times)
      const timeTokens = rest.match(/\b(\d{1,2}:\d{2}\s*(?:am|pm)?|\d{1,2}\s*(?:am|pm))\b/gi);
      if (timeTokens && timeTokens.length >= 2) {
        startRaw = timeTokens[0];
        endRaw = timeTokens[1];
      } else {
        // no valid time tokens => don't treat as shift
        continue;
      }
    }

    // Date from currentDate or inline date fallback
    let date = currentDate;
    if (!date) {
      const dm = part.match(/(\d{1,2})\s*[\/\-]\s*(\d{1,2})(?:\s*[\/\-]\s*(\d{2,4}))?/);
      if (dm) {
        const day = Number(dm[1]);
        const month = Number(dm[2]) || defaultMonth;
        let year = dm[3] ? Number(dm[3]) : defaultYear;
        if (year < 100) year = 2000 + year;
        date = toISODate(year, month, day);
      }
    }

    // âœ… Parse start using dayDefaultAp; parse end using start context
    const t1 = parseTimeToHHMM(startRaw, null, dayDefaultAp);
    const t2 = parseTimeToHHMM(endRaw, t1, dayDefaultAp);

    // Update pm context if inferred/explicit
    if (t1.ok && t1.hasAmPm && t1.ap) dayDefaultAp = t1.ap;

    if (!t1.ok || !t2.ok) warnings.push(`Could not parse time for "${name}" in: "${part}". Please edit manually.`);
    if (t1.ambiguous) warnings.push(`Ambiguous start time "${startRaw}" for "${name}" (missing am/pm).`);
    if (t2.ambiguous) warnings.push(`Ambiguous end time "${endRaw}" for "${name}" (missing am/pm).`);

    items.push({
      date: date || "",
      location: defaultLocation || "",
      employee: name,
      start: t1.ok ? t1.hhmm : "",
      end: t2.ok ? t2.hhmm : "",
      breakMin: 0,
      notes: ""
    });
  }

  return { items, warnings, dayDefaultAp };
}

function parseTimeToHHMM(raw, contextStart, defaultAp) {
  if (!raw) return { ok:false, hhmm:"", ambiguous:false, hasAmPm:false, ap:null, hour24:null };

  const s = raw.toLowerCase()
    .replace(/\./g, "")
    .replace(/\s+/g, "")
    .replace(/hrs?|hours?/g, "")
    .replace(/[^0-9apm:]/g, "");

  const m = s.match(/^(\d{1,2})(?::(\d{2}))?(am|pm)?$/);
  if (!m) return { ok:false, hhmm:"", ambiguous:false, hasAmPm:false, ap:null, hour24:null };

  let hh = Number(m[1]);
  const mm = Number(m[2] || "0");
  let ap = m[3] || null;

  if (mm < 0 || mm > 59 || hh < 0 || hh > 24) return { ok:false, hhmm:"", ambiguous:false, hasAmPm:!!ap, ap, hour24:null };

  let ambiguous = false;
  let hasAmPm = !!ap;

  function out(h24, usedAp=null) {
    const HH = String(h24).padStart(2, "0");
    const MM = String(mm).padStart(2, "0");
    return { ok:true, hhmm:`${HH}:${MM}`, ambiguous, hasAmPm: hasAmPm || !!usedAp, ap: usedAp || ap, hour24:h24 };
  }

  // explicit am/pm
  if (ap) {
    let h24 = hh;
    if (h24 === 12) h24 = 0;
    if (ap === "pm") h24 += 12;
    return out(h24, ap);
  }

  // 24h safe
  if (hh >= 13 && hh <= 24) return out(hh === 24 ? 0 : hh, null);

  // ambiguous <=12
  ambiguous = true;

  // infer from start context if start had pm
  if (contextStart && contextStart.ok && contextStart.hasAmPm && contextStart.ap === "pm") {
    ambiguous = false;
    if (hh === 12) return out(0, "pm");     // treat 12 as midnight in pm-shifts
    return out(hh + 12, "pm");
  }

  // âœ… infer from day default (e.g., earlier line had "6pm")
  if (defaultAp === "pm") {
    ambiguous = false;
    if (hh === 12) return out(0, "pm");
    return out(hh + 12, "pm");
  }

  // otherwise keep ambiguous
  return out(hh, null);
}

/* =========================
   Import Preview + Save
========================= */
function renderImportPreview(list, warnings) {
  const area = document.getElementById("previewArea");
  area.innerHTML = "";

  const warnBox = document.createElement("div");
  warnBox.className = "warn";
  warnBox.style.display = warnings.length ? "block" : "none";
  warnBox.innerText = warnings.length ? ("Warnings:\n- " + warnings.slice(0, 18).join("\n- ") + (warnings.length > 18 ? "\n- ..." : "")) : "";
  area.appendChild(warnBox);

  if (!list.length) return;

  const wrap = document.createElement("div");
  wrap.innerHTML = `
    <div style="font-weight:700; margin-top:10px;">Preview (editable)</div>
    <div class="muted">Edit any wrong date/time before saving. Times must be HH:MM (24h).</div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Date</th>
          <th>Employee</th>
          <th>Location</th>
          <th>Start</th>
          <th>End</th>
          <th class="right">Break (min)</th>
          <th class="right">Hours</th>
          <th class="right">Keep</th>
        </tr>
      </thead>
      <tbody id="importTbody"></tbody>
    </table>
  `;
  area.appendChild(wrap);

  const tbody = document.getElementById("importTbody");
  tbody.innerHTML = "";

  list.forEach((s, idx) => {
    const tr = document.createElement("tr");
    const hoursPreview = (s.date && s.start && s.end)
      ? round2(calcHours(s.start, s.end, s.breakMin || 0)).toFixed(2)
      : "0.00";

    tr.innerHTML = `
      <td class="mono">${idx+1}</td>
      <td><input data-k="date" data-i="${idx}" class="mono" value="${escapeAttr(s.date)}" placeholder="YYYY-MM-DD"></td>
      <td><input data-k="employee" data-i="${idx}" value="${escapeAttr(s.employee)}"></td>
      <td><input data-k="location" data-i="${idx}" value="${escapeAttr(s.location||"")}"></td>
      <td><input data-k="start" data-i="${idx}" class="mono" value="${escapeAttr(s.start)}" placeholder="HH:MM"></td>
      <td><input data-k="end" data-i="${idx}" class="mono" value="${escapeAttr(s.end)}" placeholder="HH:MM"></td>
      <td class="right"><input data-k="breakMin" data-i="${idx}" class="mono" type="number" min="0" step="5" value="${escapeAttr(String(s.breakMin||0))}"></td>
      <td class="right mono" id="impHours_${idx}">${hoursPreview}</td>
      <td class="right"><input data-k="keep" data-i="${idx}" type="checkbox" checked></td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("input").forEach(inp => {
    inp.addEventListener("input", () => {
      const i = Number(inp.getAttribute("data-i"));
      const k = inp.getAttribute("data-k");
      if (k === "keep") return;

      let val = inp.value;
      if (k === "breakMin") val = Number(val || 0);
      importDraft[i][k] = val;

      const s = importDraft[i];
      const cell = document.getElementById(`impHours_${i}`);
      if (cell) {
        const hrs = (s.date && s.start && s.end) ? round2(calcHours(s.start, s.end, s.breakMin||0)) : 0;
        cell.textContent = hrs.toFixed(2);
      }
    });
  });
}

function saveImported() {
  const msgEl = document.getElementById("modalMsg");
  msgEl.style.display = "none";
  msgEl.innerText = "";

  if (!importDraft || importDraft.length === 0) {
    msgEl.style.display = "block";
    msgEl.className = "warn";
    msgEl.innerText = "No parsed shifts to save.";
    return;
  }

  const tbody = document.getElementById("importTbody");
  const keepChecks = tbody ? Array.from(tbody.querySelectorAll('input[data-k="keep"]')) : [];

  const today = todayISO();
  let savedCount = 0, skippedFuture = 0, skippedInvalid = 0;

  for (let idx = 0; idx < importDraft.length; idx++) {
    const s = importDraft[idx];

    const chk = keepChecks.find(x => Number(x.getAttribute("data-i")) === idx);
    if (chk && !chk.checked) continue;

    const date = (s.date || "").trim();
    const employee = (s.employee || "").trim();
    const start = (s.start || "").trim();
    const end = (s.end || "").trim();
    const breakMin = Number(s.breakMin || 0);
    const location = (s.location || document.getElementById("location").value || "").trim();

    if (!date || !employee || !start || !end) { skippedInvalid++; continue; }
    if (date > today) { skippedFuture++; continue; }

    const v = validateShift(start, end, breakMin);
    if (!v.ok) { skippedInvalid++; continue; }

    const hours = round2(calcHours(start, end, breakMin));

    shifts.push({
      id: makeId(),
      date,
      location,
      employee,
      start,
      end,
      breakMin,
      notes: s.notes || "",
      hours
    });

    savedCount++;
  }

  save();
  render();

  if (savedCount === 0) {
    msgEl.style.display = "block";
    msgEl.className = "warn";
    msgEl.innerText = "Nothing saved. Please check date/time fields in preview.";
    return;
  }

  msgEl.style.display = "block";
  msgEl.className = "ok";
  msgEl.innerText =
    `Saved ${savedCount} shift(s).` +
    (skippedFuture ? ` Skipped future: ${skippedFuture}.` : "") +
    (skippedInvalid ? ` Skipped invalid: ${skippedInvalid}.` : "");

  // âœ… close modal after a tiny delay (avoids overlay getting stuck)
  setTimeout(() => closeImport(), 200);
}


/* =========================
   UI Helpers
========================= */
function setText(id, msg, show) {
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display = show ? "block" : "none";
  el.innerText = msg || "";
}
function setSpinner(show, msg) {
  const el = document.getElementById("ocrStatus");
  el.className = show ? "spinner show" : "spinner";
  el.innerText = msg || "";
}

/* =========================
   Utilities
========================= */
function makeId() {
  if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
  return "id_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function escapeHtml(s) {
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function escapeAttr(s) { return String(s ?? "").replace(/"/g, "&quot;"); }

/* =========================
   Init
========================= */
(function init() {
  const today = todayISO();
  const dateInput = document.getElementById("selectedDate");
  dateInput.max = today;
  dateInput.value = today;

  document.getElementById("defaultYear").value = Number(today.split("-")[0]);
  document.getElementById("defaultMonth").value = String(Number(today.split("-")[1]));

  ["startTime","endTime","breakMin"].forEach(id => {
    document.getElementById(id).addEventListener("input", updatePreview);
  });

  dateInput.addEventListener("change", () => {
    if (isFutureDate(dateInput.value)) {
      showDateMsg(true);
      alert("You canâ€™t select a higher date.");
      dateInput.value = todayISO();
      render();
      return;
    }
    showDateMsg(false);
    resetAddButton();
    render();
  });

  updatePreview();
  render();
})();
function exportCSV() {
  if (!shifts || shifts.length === 0) {
    alert("No data found. Please import and save shifts first.");
    return;
  }

  const header = ["date","location","employee","start","end","breakMin","hours","notes"];
  const rows = shifts.map(s => [
    s.date,
    s.location || "",
    s.employee,
    s.start,
    s.end,
    String(s.breakMin || 0),
    Number(s.hours || 0).toFixed(2),
    (s.notes || "").replace(/\r?\n/g," ")
  ]);

  const csv = [header, ...rows].map(r => r.join(",")).join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `shifts-${todayISO()}.csv`;
  a.click();

  URL.revokeObjectURL(url);
}

</script>
</body>
</html>
