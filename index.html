<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shift Hours Tracker</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230b4b5a'/%3E%3Cpath d='M32 14a18 18 0 1 0 0 36a18 18 0 0 0 0-36zm1 8h-2v14l10 6l1-2l-9-5V22z' fill='white'/%3E%3C/svg%3E" />
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Manrope:wght@400;500;600;700&family=Sora:wght@600;700;800&display=swap" rel="stylesheet">
<style>
/* ===================== RESET & ROOT ===================== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  color-scheme: dark;
  --bg: #060606;
  --surface: #121212;
  --surface2: #1c1c1c;
  --border: #2a2a2a;
  --border-strong: #383838;

  --ink: #f3f3f3;
  --ink-2: #d5d5d5;
  --ink-3: #9a9a9a;

  --brand: #ff7b70;
  --brand-light: #321a17;
  --brand-border: #69403b;

  --green: #53c367;
  --green-light: #112319;
  --green-border: #285634;

  --amber: #f4b158;
  --amber-light: #2c2214;
  --amber-border: #6e4f24;

  --blue: #82b9ff;
  --blue-light: #162234;
  --blue-border: #38547c;

  --shadow-sm: 0 1px 3px rgba(0,0,0,.35);
  --shadow-md: 0 4px 16px rgba(0,0,0,.45);
  --shadow-lg: 0 12px 40px rgba(0,0,0,.55);
  --focus-ring: 0 0 0 3px rgba(255,255,255,.14);
  --primary-text: #0d0d0d;
  --primary-hover: #dbdbdb;
  --overlay: rgba(0,0,0,.7);

  --radius: 12px;
  --radius-sm: 8px;
  --radius-lg: 18px;
  --mono: 'JetBrains Mono', ui-monospace, monospace;
  --font-sans: 'Manrope', 'Segoe UI', sans-serif;
  --font-display: 'Sora', var(--font-sans);
}

:root[data-theme="light"] {
  color-scheme: light;
  --bg: #f5f2ee;
  --surface: #ffffff;
  --surface2: #f0ece6;
  --border: #ddd6cc;
  --border-strong: #c4b8a8;

  --ink: #1a1714;
  --ink-2: #4a433c;
  --ink-3: #8a7f76;

  --brand: #c0392b;
  --brand-light: #fdf0ee;
  --brand-border: #e8b4ae;

  --green: #2d7a3a;
  --green-light: #edf7ee;
  --green-border: #9fcca4;

  --amber: #c07820;
  --amber-light: #fdf5e6;
  --amber-border: #e8cc90;

  --blue: #1a5fa8;
  --blue-light: #eaf2fd;
  --blue-border: #9dc5ef;

  --shadow-sm: 0 1px 3px rgba(26,23,20,.08);
  --shadow-md: 0 4px 16px rgba(26,23,20,.10);
  --shadow-lg: 0 12px 40px rgba(26,23,20,.15);
  --focus-ring: 0 0 0 3px rgba(26,23,20,.08);
  --primary-text: #ffffff;
  --primary-hover: #2d2926;
  --overlay: rgba(26,23,20,.5);
}

body {
  font-family: var(--font-sans);
  background: var(--bg);
  color: var(--ink);
  font-size: 14px;
  line-height: 1.5;
  min-height: 100vh;
}

/* ===================== LAYOUT ===================== */
.app-header {
  background: var(--surface);
  border-bottom: 1.5px solid var(--border-strong);
  padding: 14px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 800;
  color: var(--brand);
  letter-spacing: -0.5px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.logo-dot {
  width: 8px; height: 8px;
  background: var(--brand);
  border-radius: 50%;
  display: inline-block;
}

.header-kpis {
  display: flex;
  gap: 24px;
}
.header-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 14px;
}
.theme-toggle {
  min-width: 110px;
  justify-content: center;
  background: var(--surface2);
}
.header-kpi {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
}
.header-kpi-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: var(--ink-3);
}
.header-kpi-value {
  font-family: var(--mono);
  font-size: 22px;
  font-weight: 500;
  color: var(--ink);
  line-height: 1.1;
}
.header-kpi-value span {
  font-size: 12px;
  color: var(--ink-3);
}

.container {
  width: min(1320px, 100% - 32px);
  margin: 20px auto;
  display: grid;
  grid-template-columns: 1.5fr 1fr;
  gap: 18px;
}
@media (max-width: 960px) {
  .container { grid-template-columns: 1fr; }
  .header-kpis { display: none; }
  .app-header { padding: 12px 16px; }
}

/* ===================== CARDS ===================== */
.card {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}

.card-header {
  padding: 14px 18px;
  border-bottom: 1.5px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}
.card-title {
  font-family: var(--font-display);
  font-size: 13px;
  font-weight: 800;
  letter-spacing: .06em;
  text-transform: uppercase;
  color: var(--ink-2);
}
.card-body { padding: 18px; }

/* ===================== FORM CONTROLS ===================== */
.form-grid {
  display: grid;
  grid-template-columns: 1.4fr 1fr auto;
  gap: 12px;
  margin-bottom: 14px;
}
@media (max-width: 700px) {
  .form-grid { grid-template-columns: 1fr; }
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 12px;
}
@media (max-width: 500px) {
  .form-row { grid-template-columns: 1fr; }
}

.field { display: flex; flex-direction: column; gap: 5px; }

label {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: .07em;
  text-transform: uppercase;
  color: var(--ink-3);
}

input[type="text"],
input[type="number"],
input[type="date"],
input[type="time"],
select,
textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--surface);
  color: var(--ink);
  font-family: var(--font-sans);
  font-size: 13.5px;
  outline: none;
  transition: border-color .15s, box-shadow .15s;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--ink);
  box-shadow: var(--focus-ring);
}
input::placeholder { color: var(--ink-3); }
textarea { resize: vertical; min-height: 90px; }

.warn-msg {
  font-size: 12px;
  color: var(--brand);
  font-weight: 600;
  display: none;
  margin-top: 4px;
}
.warn-msg.show { display: block; }
.ok-msg {
  font-size: 12px;
  color: var(--green);
  font-weight: 600;
  display: none;
  margin-top: 4px;
}
.ok-msg.show { display: block; }

/* ===================== PREVIEW BOX ===================== */
.preview-box {
  background: var(--blue-light);
  border: 1.5px solid var(--blue-border);
  border-radius: var(--radius-sm);
  padding: 12px 14px;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}
.preview-box-hours {
  font-family: var(--mono);
  font-size: 30px;
  font-weight: 500;
  color: var(--blue);
  line-height: 1;
}
.preview-box-hrs {
  font-size: 13px;
  color: var(--blue);
  margin-left: 2px;
}
.preview-box-meta {
  font-size: 12px;
  color: var(--ink-3);
}

/* ===================== BUTTONS ===================== */
.btn {
  padding: 10px 16px;
  border-radius: var(--radius-sm);
  border: 1.5px solid var(--border-strong);
  background: var(--surface);
  color: var(--ink);
  font-family: var(--font-sans);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: background .12s, border-color .12s, transform .08s, box-shadow .12s;
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.btn:hover { background: var(--surface2); }
.btn:active { transform: scale(.98); }

.btn-primary {
  background: var(--ink);
  color: var(--primary-text);
  border-color: var(--ink);
}
.btn-primary:hover { background: var(--primary-hover); border-color: var(--primary-hover); }

.btn-green {
  background: var(--green);
  color: #fff;
  border-color: var(--green);
}
.btn-green:hover { background: #25662f; border-color: #25662f; }

.btn-danger {
  background: var(--surface);
  color: var(--brand);
  border-color: var(--brand-border);
}
.btn-danger:hover { background: var(--brand-light); }

.btn-sm {
  padding: 5px 10px;
  font-size: 11px;
  border-radius: 6px;
}

.btn-icon {
  width: 32px;
  height: 32px;
  padding: 0;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  font-size: 14px;
}

.action-bar {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 14px;
  padding-top: 14px;
  border-top: 1.5px solid var(--border);
}
.action-bar .btn-danger {
  grid-column: 1 / -1;
}

/* ===================== TABLES ===================== */
.table-wrap {
  overflow-x: auto;
  margin-top: 10px;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: var(--ink-3);
  text-align: left;
  padding: 8px 10px;
  border-bottom: 1.5px solid var(--border);
  white-space: nowrap;
}
td {
  padding: 9px 10px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
  font-size: 13px;
}
tbody tr:last-child td { border-bottom: none; }
tbody tr:hover td { background: var(--surface2); }
.td-right { text-align: right; }
.td-mono { font-family: var(--mono); font-size: 12.5px; }
.td-muted { color: var(--ink-3); font-size: 12px; font-style: italic; }
.td-actions { display: flex; gap: 5px; justify-content: flex-end; }

.clickable-row { cursor: pointer; }
.clickable-row:hover td { background: var(--blue-light) !important; }

/* ===================== PILLS / BADGES ===================== */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 3px 9px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: .04em;
}
.badge-amber {
  background: var(--amber-light);
  border: 1px solid var(--amber-border);
  color: var(--amber);
}
.badge-blue {
  background: var(--blue-light);
  border: 1px solid var(--blue-border);
  color: var(--blue);
}

/* ===================== DIVIDER ===================== */
.divider {
  border: none;
  border-top: 1.5px solid var(--border);
  margin: 16px 0;
}

/* ===================== TOAST ===================== */
#toast-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 99999;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}
.toast {
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  box-shadow: var(--shadow-lg);
  pointer-events: auto;
  display: flex;
  align-items: center;
  gap: 8px;
  animation: slideIn .25s cubic-bezier(.25,.46,.45,.94) forwards;
  max-width: 320px;
}
.toast.success { background: #1a2e1c; color: #a8e6ad; }
.toast.error   { background: #2e1a1a; color: #e6a8a8; }
.toast.info    { background: #1a1e2e; color: #a8b8e6; }
.toast.out     { animation: slideOut .25s ease forwards; }
@keyframes slideIn { from { opacity:0; transform:translateX(40px); } to { opacity:1; transform:translateX(0); } }
@keyframes slideOut { from { opacity:1; transform:translateX(0); } to { opacity:0; transform:translateX(40px); } }

/* ===================== MODAL ===================== */
.modal-back {
  position: fixed;
  inset: 0;
  background: var(--overlay);
  backdrop-filter: blur(3px);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
  z-index: 9999;
}
.modal-back.open { display: flex; }

.modal {
  background: var(--surface);
  border: 1.5px solid var(--border-strong);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  width: min(960px, 100%);
  max-height: 90vh;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  animation: modalIn .2s cubic-bezier(.25,.46,.45,.94) forwards;
}
@keyframes modalIn { from { opacity:0; transform:translateY(20px) scale(.97); } to { opacity:1; transform:none; } }

.modal-header {
  padding: 16px 20px;
  border-bottom: 1.5px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  position: sticky;
  top: 0;
  background: var(--surface);
  z-index: 1;
}
.modal-title {
  font-family: var(--font-display);
  font-size: 16px;
  font-weight: 800;
  color: var(--ink);
}
.modal-body { padding: 18px 20px; flex: 1; }
.modal-footer {
  padding: 14px 20px;
  border-top: 1.5px solid var(--border);
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  position: sticky;
  bottom: 0;
  background: var(--surface);
}

/* ===================== TABS ===================== */
.tabs {
  display: flex;
  gap: 0;
  border-bottom: 1.5px solid var(--border);
  margin-bottom: 16px;
}
.tab {
  padding: 10px 18px;
  font-size: 13px;
  font-weight: 600;
  color: var(--ink-3);
  cursor: pointer;
  border-bottom: 2.5px solid transparent;
  margin-bottom: -1.5px;
  transition: color .15s, border-color .15s;
  user-select: none;
}
.tab.active {
  color: var(--ink);
  border-bottom-color: var(--ink);
}
.tab:hover:not(.active) { color: var(--ink-2); }

.section { display: none; }
.section.active { display: block; }

/* ===================== OCR SPINNER ===================== */
.ocr-status {
  background: var(--amber-light);
  border: 1px solid var(--amber-border);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  font-size: 13px;
  color: var(--amber);
  font-weight: 600;
  display: none;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
}
.ocr-status.show { display: flex; }
.spinner-dot {
  width: 8px; height: 8px;
  background: var(--amber);
  border-radius: 50%;
  animation: pulse 1s ease-in-out infinite;
}
@keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:.3;} }

/* ===================== IMPORT PREVIEW TABLE ===================== */
.import-preview-table td input {
  padding: 5px 8px;
  font-size: 12px;
  border-radius: 5px;
  min-width: 60px;
}
.import-preview-table td input[type="number"] { width: 60px; }

/* ===================== SMALL NOTE ===================== */
.small-note {
  font-size: 11px;
  color: var(--ink-3);
  margin-top: 4px;
}

/* ===================== EMPTY STATE ===================== */
.empty-state {
  text-align: center;
  padding: 32px 16px;
  color: var(--ink-3);
  font-size: 13px;
}
.empty-state-icon {
  font-size: 28px;
  margin-bottom: 8px;
}

/* ===================== EDITING BANNER ===================== */
.editing-banner {
  background: var(--amber-light);
  border: 1.5px solid var(--amber-border);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  margin-bottom: 14px;
  display: none;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  font-size: 13px;
  color: var(--amber);
  font-weight: 600;
}
.editing-banner.show { display: flex; }

/* ===================== SECTION HEADING ===================== */
.section-heading {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  margin-bottom: 10px;
}
.section-label {
  font-family: var(--font-display);
  font-size: 12px;
  font-weight: 800;
  letter-spacing: .06em;
  text-transform: uppercase;
  color: var(--ink-2);
}
</style>
</head>
<body>

<!-- ===================== TOAST CONTAINER ===================== -->
<div id="toast-container"></div>

<!-- ===================== HEADER ===================== -->
<header class="app-header">
  <div class="logo">
    <span class="logo-dot"></span>
    Shift Tracker
  </div>
  <div class="header-right">
    <button id="themeToggle" class="btn btn-sm theme-toggle" type="button" onclick="toggleTheme()" aria-label="Switch to light theme" title="Switch to light theme">Theme: Dark</button>
    <div class="header-kpis">
      <div class="header-kpi">
        <span class="header-kpi-label">Today</span>
        <span class="header-kpi-value"><span id="hdrDailyTotal">0.00</span> <span>hrs</span></span>
      </div>
      <div class="header-kpi">
        <span class="header-kpi-label">All Time</span>
        <span class="header-kpi-value"><span id="hdrAllTotal">0.00</span> <span>hrs</span></span>
      </div>
      <div class="header-kpi">
        <span class="header-kpi-label">Entries</span>
        <span class="header-kpi-value" id="hdrCount">0</span>
      </div>
    </div>
  </div>
</header>

<!-- ===================== MAIN LAYOUT ===================== -->
<div class="container">

  <!-- LEFT COLUMN -->
  <div style="display:flex; flex-direction:column; gap:18px;">

    <!-- Entry Form -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">Log a Shift</span>
        <button class="btn btn-sm" onclick="openImport()">‚¨Ü Import (Paste / PDF / JPG)</button>
      </div>
      <div class="card-body">

        <div id="editingBanner" class="editing-banner">
          <span>‚úèÔ∏è Editing shift ‚Äî make changes and click Save.</span>
          <button class="btn btn-sm btn-danger" onclick="cancelEdit()">‚úï Cancel</button>
        </div>

        <div class="form-grid">
          <div class="field">
            <label>Date <span style="color:var(--brand)">*</span></label>
            <input id="selectedDate" type="date" />
            <div id="dateMsg" class="warn-msg">Future dates are not allowed.</div>
          </div>
          <div class="field">
            <label>Location / Site</label>
            <input id="location" type="text" placeholder="e.g. Harrow / Osterley" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <select id="locationHistory" onchange="applyLocationFromHistory()" title="Recent locations">
              <option value="">üìç Recent‚Ä¶</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Employee Name <span style="color:var(--brand)">*</span></label>
            <input id="employee" type="text" placeholder="e.g. Kiran" />
          </div>
          <div class="field">
            <label>Break (minutes)</label>
            <input id="breakMin" type="number" min="0" step="5" value="0" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Start Time <span style="color:var(--brand)">*</span></label>
            <input id="startTime" type="time" />
          </div>
          <div class="field">
            <label>End Time <span style="color:var(--brand)">*</span></label>
            <input id="endTime" type="time" />
          </div>
        </div>

        <div class="field" style="margin-bottom:14px;">
          <label>Notes (optional)</label>
          <input id="notes" type="text" placeholder="Any extra details‚Ä¶" />
        </div>

        <!-- Preview -->
        <div class="preview-box">
          <div>
            <div style="font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--blue);margin-bottom:4px;">Preview</div>
            <span class="preview-box-hours" id="previewHours">0.00</span>
            <span class="preview-box-hrs">hrs</span>
            <div id="previewWarn" class="warn-msg" style="margin-top:4px;"></div>
          </div>
          <div class="preview-box-meta">Overnight shifts supported<br>(e.g. 17:00 ‚Üí 03:30)</div>
        </div>

        <div class="action-bar">
          <button id="addBtn" class="btn btn-green" onclick="addShift()">‚úì Add Shift</button>
          <button class="btn" onclick="exportCSV()">‚¨á Export CSV</button>
          <button class="btn btn-danger" onclick="clearAll()">üóë Clear All Data</button>
        </div>
      </div>
    </div>

    <!-- Daily Shifts Table -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">Shifts for <span id="dateLabel" style="color:var(--brand)">‚Äî</span></span>
        <span class="badge badge-blue"><span id="dailyTotal">0.00</span> hrs total</span>
      </div>
      <div class="card-body" style="padding:0;">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Employee</th>
                <th>Location</th>
                <th>Shift</th>
                <th class="td-right">Hours</th>
                <th class="td-right">Actions</th>
              </tr>
            </thead>
            <tbody id="dailyTable"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- RIGHT COLUMN -->
  <div style="display:flex; flex-direction:column; gap:18px;">

    <!-- By Date Summary -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">By Date</span>
        <span class="badge badge-amber"><span id="countAll">0</span> total entries</span>
      </div>
      <div class="card-body" style="padding:0;">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th class="td-right">Total hrs</th>
                <th class="td-right">Entries</th>
              </tr>
            </thead>
            <tbody id="byDateTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Employee Detail -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">Employee View</span>
        <span class="badge badge-blue"><span id="empTotal">0.00</span> hrs</span>
      </div>
      <div class="card-body">
        <div class="field" style="margin-bottom:12px;">
          <label>Choose Employee</label>
          <select id="employeeSelect" onchange="renderEmployeeDetail()">
            <option value="">‚Äî Select ‚Äî</option>
          </select>
        </div>
      </div>
      <div class="table-wrap" style="margin:0 0 0 0;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Location</th>
              <th>Shift</th>
              <th class="td-right">Hrs</th>
            </tr>
          </thead>
          <tbody id="employeeTable"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- ===================== IMPORT MODAL ===================== -->
<div id="modalBack" class="modal-back">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title">Import Shifts</div>
        <div style="font-size:12px;color:var(--ink-3);margin-top:2px;">Paste text or upload PDF/JPG ‚Üí OCR ‚Üí preview ‚Üí save</div>
      </div>
      <button class="btn btn-sm" onclick="closeImport()">‚úï Close</button>
    </div>

    <div class="modal-body">

      <!-- Parse defaults -->
      <div class="form-row" style="margin-bottom:14px;">
        <div class="field">
          <label>Default Month</label>
          <select id="defaultMonth">
            <option value="1">January</option><option value="2">February</option><option value="3">March</option>
            <option value="4">April</option><option value="5">May</option><option value="6">June</option>
            <option value="7">July</option><option value="8">August</option><option value="9">September</option>
            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
          </select>
          <div class="small-note">UK format: 7/2 = 7 Feb</div>
        </div>
        <div class="field">
          <label>Default Year</label>
          <input id="defaultYear" type="number" min="2000" max="2100" />
        </div>
        <div class="field">
          <label>Default Location</label>
          <input id="defaultLocationImport" type="text" placeholder="e.g. Osterley" />
          <div class="small-note">Used when lines don't include location</div>
        </div>
      </div>

      <div id="autoDetected" class="ok-msg" style="margin-bottom:12px;"></div>

      <!-- Tabs -->
      <div class="tabs">
        <div id="tabPaste" class="tab active" onclick="switchTab('paste')">üìã Paste Text</div>
        <div id="tabUpload" class="tab" onclick="switchTab('upload')">üìÑ Upload PDF / JPG</div>
      </div>

      <!-- Paste Section -->
      <div id="sectionPaste" class="section active">
        <div class="field" style="margin-bottom:10px;">
          <label>Paste shift notes</label>
          <textarea id="pasteText" placeholder="Example:
Osterley February 2026
1/2
Simran 6pm to 12
Kiran 7pm to 11
2/2
..."></textarea>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="parseFromPaste()">Parse ‚Üí Preview</button>
          <button class="btn" onclick="clearImportDraft()">Clear</button>
        </div>
        <div id="pasteWarn" class="warn-msg" style="margin-top:8px;"></div>
      </div>

      <!-- Upload Section -->
      <div id="sectionUpload" class="section">
        <div class="field" style="margin-bottom:10px;">
          <label>Upload PDF or Image (JPG / PNG)</label>
          <input id="uploadFile" type="file" accept=".pdf,image/*" />
          <div class="small-note">PDFs: up to 3 pages. Plain text images work best.</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="ocrFromUpload()">Run OCR ‚Üí Preview</button>
          <button class="btn" onclick="clearImportDraft()">Clear</button>
        </div>
        <div id="ocrStatus" class="ocr-status">
          <div class="spinner-dot"></div>
          <span id="ocrStatusText">Running OCR‚Ä¶</span>
        </div>
        <div id="uploadWarn" class="warn-msg" style="margin-top:8px;"></div>
      </div>

      <!-- Extracted text (shared between both tabs) -->
      <div style="margin-top:14px;">
        <div class="section-heading">
          <label>Extracted / editable text</label>
          <button class="btn btn-sm" onclick="copyExtracted()">Copy</button>
        </div>
        <textarea id="extractedText" placeholder="Extracted text will appear here‚Ä¶"></textarea>
        <div style="display:flex;gap:10px;margin-top:8px;">
          <button class="btn btn-primary" onclick="parseFromExtracted()">Parse Extracted ‚Üí Preview</button>
        </div>
        <div id="parseWarn" class="warn-msg" style="margin-top:6px;"></div>
        <div id="parseOk" class="ok-msg" style="margin-top:6px;"></div>
      </div>

      <!-- Preview area -->
      <div id="previewArea" style="margin-top:16px;"></div>
      <div id="modalMsg" class="warn-msg" style="margin-top:10px;"></div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-green" onclick="saveImported()">‚úì Save Imported Shifts</button>
      <button class="btn" onclick="closeImport()">Done</button>
    </div>
  </div>
</div>

<!-- ===================== SCRIPT ===================== -->
<script>
/* ===================================================
   STORAGE
=================================================== */
const STORAGE_KEY = "shift_hours_tracker_v6_whatsapp";
const THEME_KEY = "shift_hours_tracker_theme";
let shifts = load();
function load() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); } catch { return []; } }
function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(shifts)); }
function getSavedTheme() {
  const v = localStorage.getItem(THEME_KEY);
  return (v === "light" || v === "dark") ? v : "dark";
}
function applyTheme(theme) {
  const next = theme === "light" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem(THEME_KEY, next);
  const btn = document.getElementById("themeToggle");
  if (!btn) return;
  const isDark = next === "dark";
  btn.textContent = isDark ? "Theme: Dark" : "Theme: Light";
  const alt = isDark ? "light" : "dark";
  btn.setAttribute("aria-label", `Switch to ${alt} theme`);
  btn.title = `Switch to ${alt} theme`;
}
function toggleTheme() {
  const curr = document.documentElement.getAttribute("data-theme") === "light" ? "light" : "dark";
  applyTheme(curr === "dark" ? "light" : "dark");
}

/* ===================================================
   DATE UTILS
=================================================== */
function todayISO() {
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function pad(n) { return String(n).padStart(2,"0"); }
function isFutureDate(s) { return !!s && s > todayISO(); }

/* ===================================================
   TIME UTILS
=================================================== */
function toMinutes(hhmm) { const [h,m]=hhmm.split(":").map(Number); return h*60+m; }
function durationMinutes(s,e) { let sm=toMinutes(s),em=toMinutes(e); if(em<sm)em+=1440; return em-sm; }
function calcHours(s,e,brk) { const net=durationMinutes(s,e)-Number(brk||0); return net<=0?0:net/60; }
function round2(x) { return Math.round(x*100)/100; }

/* ===================================================
   VALIDATION
=================================================== */
function validateShift(start, end, breakMin) {
  if (!start || !end) return { ok:false, message:"Start and End time are required." };
  const dur = durationMinutes(start, end);
  const net = dur - Number(breakMin||0);
  if (dur === 0) return { ok:false, message:"Start and End time cannot be the same." };
  if (net <= 0) return { ok:false, message:"Break cannot exceed shift duration." };
  if (net > 960) return { ok:true, warn:"This shift is longer than 16 hours ‚Äî double check?" };
  return { ok:true };
}

/* ===================================================
   AGGREGATIONS
=================================================== */
function shiftsForDate(d) { return shifts.filter(s=>s.date===d); }
function totalHoursForDate(d) { return round2(shiftsForDate(d).reduce((a,s)=>a+s.hours,0)); }
function allHoursTotal() { return round2(shifts.reduce((a,s)=>a+s.hours,0)); }
function totalsByDate() {
  const map = new Map();
  for (const s of shifts) {
    const c = map.get(s.date)||{total:0,count:0};
    c.total+=s.hours; c.count+=1; map.set(s.date,c);
  }
  return [...map.entries()].sort((a,b)=>b[0].localeCompare(a[0]))
    .map(([date,v])=>({date, total:round2(v.total), count:v.count}));
}
function totalsByEmployee() {
  const map = new Map();
  for (const s of shifts) map.set(s.employee,(map.get(s.employee)||0)+s.hours);
  return [...map.entries()].map(([employee,total])=>({employee,total:round2(total)}))
    .sort((a,b)=>a.employee.localeCompare(b.employee));
}
function shiftsByEmployee(name) {
  return shifts.filter(s=>s.employee===name)
    .sort((a,b)=>(a.date+a.start).localeCompare(b.date+b.start));
}
function recentLocations() {
  const seen=new Set(), locs=[];
  for (const s of [...shifts].reverse()) {
    if (s.location && !seen.has(s.location)) { seen.add(s.location); locs.push(s.location); }
    if (locs.length>=6) break;
  }
  return locs;
}

/* ===================================================
   TOAST
=================================================== */
function toast(msg, type="info", duration=3000) {
  const c = document.getElementById("toast-container");
  const el = document.createElement("div");
  el.className = `toast ${type}`;
  const icons = {success:"‚úì", error:"‚úï", info:"‚Ñπ"};
  el.innerHTML = `<span>${icons[type]||"‚Ñπ"}</span> ${escapeHtml(msg)}`;
  c.appendChild(el);
  setTimeout(()=>{ el.classList.add("out"); setTimeout(()=>el.remove(),260); }, duration);
}

/* ===================================================
   RENDER
=================================================== */
function render() {
  const selectedDate = document.getElementById("selectedDate").value;
  document.getElementById("dateLabel").textContent = selectedDate || "‚Äî";
  document.getElementById("countAll").textContent = String(shifts.length);
  document.getElementById("dailyTotal").textContent = totalHoursForDate(selectedDate).toFixed(2);
  const allTotalEl = document.getElementById("allTotal");
  if (allTotalEl) allTotalEl.textContent = allHoursTotal().toFixed(2);
  document.getElementById("hdrDailyTotal").textContent = totalHoursForDate(selectedDate).toFixed(2);
  document.getElementById("hdrAllTotal").textContent = allHoursTotal().toFixed(2);
  document.getElementById("hdrCount").textContent = String(shifts.length);

  // Daily table
  const daily = shiftsForDate(selectedDate).sort((a,b)=>a.start.localeCompare(b.start));
  const dailyBody = document.getElementById("dailyTable");
  if (daily.length === 0) {
    dailyBody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">üìã</div>No shifts logged for this date.</div></td></tr>`;
  } else {
    dailyBody.innerHTML = daily.map(s=>`
      <tr>
        <td><strong>${escapeHtml(s.employee)}</strong></td>
        <td class="td-mono" style="color:var(--ink-3);">${escapeHtml(s.location||"‚Äî")}</td>
        <td class="td-mono">${s.start} ‚Üí ${s.end}${s.breakMin?` <span style="color:var(--ink-3);font-size:11px;">(${s.breakMin}m brk)</span>`:""}</td>
        <td class="td-right td-mono"><strong>${s.hours.toFixed(2)}</strong></td>
        <td class="td-right">
          <div class="td-actions">
            <button class="btn btn-sm" onclick="editShift('${s.id}')">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteShift('${s.id}')">Del</button>
          </div>
        </td>
      </tr>`).join("");
  }

  // By date
  const byDate = totalsByDate();
  const byDateBody = document.getElementById("byDateTable");
  if (byDate.length === 0) {
    byDateBody.innerHTML = `<tr><td colspan="3"><div class="empty-state"><div class="empty-state-icon">üìÖ</div>No data yet.</div></td></tr>`;
  } else {
    byDateBody.innerHTML = byDate.map(row=>`
      <tr class="clickable-row" onclick="jumpToDate('${row.date}')">
        <td class="td-mono">${row.date}</td>
        <td class="td-right td-mono">${row.total.toFixed(2)}</td>
        <td class="td-right td-mono">${row.count}</td>
      </tr>`).join("");
  }

  // Employee dropdown
  const empSelect = document.getElementById("employeeSelect");
  const current = empSelect.value;
  const emps = totalsByEmployee();
  empSelect.innerHTML = `<option value="">‚Äî Select ‚Äî</option>` +
    emps.map(e=>`<option value="${escapeAttr(e.employee)}">${escapeHtml(e.employee)} (${e.total.toFixed(2)}h)</option>`).join("");
  if (emps.some(e=>e.employee===current)) empSelect.value = current;

  // Location history dropdown
  const locHist = document.getElementById("locationHistory");
  const locs = recentLocations();
  locHist.innerHTML = `<option value="">üìç Recent‚Ä¶</option>` +
    locs.map(l=>`<option value="${escapeAttr(l)}">${escapeHtml(l)}</option>`).join("");

  renderEmployeeDetail();
}

function jumpToDate(date) {
  document.getElementById("selectedDate").value = date;
  render();
  window.scrollTo({top:0, behavior:"smooth"});
}

function renderEmployeeDetail() {
  const emp = document.getElementById("employeeSelect").value;
  const body = document.getElementById("employeeTable");
  const totalEl = document.getElementById("empTotal");
  if (!emp) {
    totalEl.textContent = "0.00";
    body.innerHTML = `<tr><td colspan="4"><div class="empty-state"><div class="empty-state-icon">üë§</div>Select an employee above.</div></td></tr>`;
    return;
  }
  const list = shiftsByEmployee(emp);
  totalEl.textContent = round2(list.reduce((a,s)=>a+s.hours,0)).toFixed(2);
  if (list.length === 0) {
    body.innerHTML = `<tr><td colspan="4"><div class="empty-state">No shifts found.</div></td></tr>`;
    return;
  }
  body.innerHTML = list.map(s=>`
    <tr>
      <td class="td-mono">${s.date}</td>
      <td style="color:var(--ink-3)">${escapeHtml(s.location||"‚Äî")}</td>
      <td class="td-mono">${s.start} ‚Üí ${s.end}${s.breakMin?` <span style="color:var(--ink-3);font-size:11px;">(${s.breakMin}m)</span>`:""}</td>
      <td class="td-right td-mono">${s.hours.toFixed(2)}</td>
    </tr>`).join("");
}

/* ===================================================
   READ FORM
=================================================== */
function readForm() {
  return {
    date: document.getElementById("selectedDate").value,
    location: document.getElementById("location").value.trim(),
    employee: document.getElementById("employee").value.trim(),
    start: document.getElementById("startTime").value,
    end: document.getElementById("endTime").value,
    breakMin: Number(document.getElementById("breakMin").value||0),
    notes: document.getElementById("notes").value.trim(),
  };
}

/* ===================================================
   CRUD
=================================================== */
function addShift() {
  const f = readForm();
  if (isFutureDate(f.date)) { showDateMsg(true); return; }
  showDateMsg(false);
  if (!f.date || !f.employee || !f.start || !f.end) {
    toast("Please fill in date, employee, start and end time.","error"); return;
  }
  const v = validateShift(f.start, f.end, f.breakMin);
  if (!v.ok) { toast(v.message,"error"); return; }
  if (v.warn) toast(v.warn,"info",5000);
  const hours = round2(calcHours(f.start, f.end, f.breakMin));
  shifts.push({ id:makeId(), ...f, hours });
  save(); clearForm(); render();
  toast("Shift added successfully.","success");
}

let _editId = null;
function editShift(id) {
  const s = shifts.find(x=>x.id===id);
  if (!s) return;
  _editId = id;
  document.getElementById("selectedDate").value = s.date;
  document.getElementById("location").value = s.location||"";
  document.getElementById("employee").value = s.employee;
  document.getElementById("startTime").value = s.start;
  document.getElementById("endTime").value = s.end;
  document.getElementById("breakMin").value = String(s.breakMin||0);
  document.getElementById("notes").value = s.notes||"";
  document.getElementById("addBtn").textContent = "‚úì Save Changes";
  document.getElementById("addBtn").onclick = saveEdit;
  document.getElementById("editingBanner").classList.add("show");
  updatePreview();
  window.scrollTo({top:0, behavior:"smooth"});
}

function saveEdit() {
  const f = readForm();
  if (isFutureDate(f.date)) { showDateMsg(true); return; }
  showDateMsg(false);
  if (!f.date || !f.employee || !f.start || !f.end) {
    toast("Please fill in all required fields.","error"); return;
  }
  const v = validateShift(f.start, f.end, f.breakMin);
  if (!v.ok) { toast(v.message,"error"); return; }
  const idx = shifts.findIndex(x=>x.id===_editId);
  if (idx===-1) return;
  const hours = round2(calcHours(f.start, f.end, f.breakMin));
  shifts[idx] = { ...shifts[idx], ...f, hours };
  save(); resetAddBtn(); clearForm(); render();
  toast("Shift updated.","success");
}

function cancelEdit() { resetAddBtn(); clearForm(); render(); }

function deleteShift(id) {
  if (!confirm("Delete this shift?")) return;
  shifts = shifts.filter(s=>s.id!==id);
  save(); render();
  toast("Shift deleted.","info");
}

function clearAll() {
  if (!confirm("Delete ALL saved shifts from this browser? This cannot be undone.")) return;
  shifts = []; save(); resetAddBtn(); clearForm(); render();
  toast("All data cleared.","info");
}

function resetAddBtn() {
  _editId = null;
  document.getElementById("addBtn").textContent = "‚úì Add Shift";
  document.getElementById("addBtn").onclick = addShift;
  document.getElementById("editingBanner").classList.remove("show");
}

function clearForm() {
  document.getElementById("employee").value = "";
  document.getElementById("startTime").value = "";
  document.getElementById("endTime").value = "";
  document.getElementById("breakMin").value = "0";
  document.getElementById("notes").value = "";
  updatePreview();
}

function applyLocationFromHistory() {
  const val = document.getElementById("locationHistory").value;
  if (val) document.getElementById("location").value = val;
}

/* ===================================================
   PREVIEW (debounced)
=================================================== */
let _previewTimer;
function updatePreview() {
  clearTimeout(_previewTimer);
  _previewTimer = setTimeout(_doPreview, 80);
}
function _doPreview() {
  const start = document.getElementById("startTime").value;
  const end = document.getElementById("endTime").value;
  const brk = Number(document.getElementById("breakMin").value||0);
  const warnEl = document.getElementById("previewWarn");
  warnEl.style.display = "none"; warnEl.textContent = "";
  if (!start || !end) { document.getElementById("previewHours").textContent="0.00"; return; }
  const v = validateShift(start, end, brk);
  if (!v.ok) {
    document.getElementById("previewHours").textContent="0.00";
    warnEl.style.display="block"; warnEl.textContent=v.message; return;
  }
  document.getElementById("previewHours").textContent = round2(calcHours(start,end,brk)).toFixed(2);
  if (v.warn) { warnEl.style.display="block"; warnEl.textContent=v.warn; }
}

function showDateMsg(show) {
  document.getElementById("dateMsg").classList.toggle("show", show);
  if (show) { document.getElementById("selectedDate").value = todayISO(); render(); }
}

/* ===================================================
   CSV EXPORT
=================================================== */
function csvCell(v) {
  const s = String(v??"");
  return (s.includes(",")||s.includes('"')||s.includes("\n")) ? `"${s.replace(/"/g,'""')}"` : s;
}
function exportCSV() {
  if (!shifts.length) { toast("No data to export.","error"); return; }
  const header = ["date","location","employee","start","end","breakMin","hours","notes"];
  const rows = [...shifts]
    .sort((a,b)=>(a.date+a.employee+a.start).localeCompare(b.date+b.employee+b.start))
    .map(s=>[s.date, s.location||"", s.employee, s.start, s.end,
             String(s.breakMin||0), Number(s.hours||0).toFixed(2),
             (s.notes||"").replace(/\r?\n/g," ")]);
  const csv = [header,...rows].map(r=>r.map(csvCell).join(",")).join("\n");
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8"}));
  a.download = `shifts-${todayISO()}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast("CSV exported.","success");
}

/* ===================================================
   IMPORT MODAL
=================================================== */
let importDraft = [];

function openImport() {
  document.getElementById("modalBack").classList.add("open");
  const [y,m] = (document.getElementById("selectedDate").value||todayISO()).split("-").map(Number);
  document.getElementById("defaultYear").value = y;
  document.getElementById("defaultMonth").value = String(m);
  document.getElementById("defaultLocationImport").value = document.getElementById("location").value.trim();
  hideEl("autoDetected"); hideEl("pasteWarn"); hideEl("uploadWarn"); hideEl("parseWarn"); hideEl("parseOk"); hideEl("modalMsg");
}
function closeImport() {
  const back = document.getElementById("modalBack");
  back.classList.remove("open");
  back.style.pointerEvents="none";
  setTimeout(()=>back.style.pointerEvents="",0);
}
function switchTab(w) {
  ["paste","upload"].forEach(t=>{
    document.getElementById("tab"+cap(t)).classList.toggle("active",t===w);
    document.getElementById("section"+cap(t)).classList.toggle("active",t===w);
  });
}
function cap(s) { return s.charAt(0).toUpperCase()+s.slice(1); }

function clearImportDraft() {
  importDraft = [];
  document.getElementById("pasteText").value="";
  document.getElementById("extractedText").value="";
  document.getElementById("previewArea").innerHTML="";
  ["pasteWarn","uploadWarn","parseWarn","parseOk","autoDetected","modalMsg"].forEach(hideEl);
  setSpinner(false,"");
}

function copyExtracted() {
  const t = document.getElementById("extractedText").value;
  navigator.clipboard?.writeText(t);
  toast("Copied to clipboard.","success");
}

function parseFromPaste() {
  const txt = document.getElementById("pasteText").value.trim();
  if (!txt) { showEl("pasteWarn","Paste some text first."); return; }
  hideEl("pasteWarn");
  document.getElementById("extractedText").value = txt;
  parseFromExtracted();
}

function parseFromExtracted() {
  const txt = document.getElementById("extractedText").value.trim();
  if (!txt) { showEl("parseWarn","No text to parse."); return; }

  const det = detectMonthYearFromText(txt);
  if (det) {
    document.getElementById("defaultMonth").value = String(det.month);
    document.getElementById("defaultYear").value = String(det.year);
    if (det.locationGuess && !document.getElementById("defaultLocationImport").value.trim()) {
      document.getElementById("defaultLocationImport").value = det.locationGuess;
    }
    showEl("autoDetected",`Auto-detected: ${det.monthName} ${det.year}${det.locationGuess?" ‚Ä¢ "+det.locationGuess:""}`, true);
  } else hideEl("autoDetected");

  const defYear = Number(document.getElementById("defaultYear").value||new Date().getFullYear());
  const defMonth = Number(document.getElementById("defaultMonth").value||(new Date().getMonth()+1));
  const defLoc = document.getElementById("defaultLocationImport").value.trim();

  const result = parseShiftsFromText(txt, defYear, defMonth, defLoc);
  importDraft = result.shifts;
  renderImportPreview(importDraft, result.warnings);

  if (!importDraft.length) {
    hideEl("parseOk");
    showEl("parseWarn","No shifts detected. Tip: add a date line like '1/2' before shifts.");
  } else {
    hideEl("parseWarn");
    showEl("parseOk",`Parsed ${importDraft.length} shift(s). ${result.warnings.length} warning(s). Review before saving.`, true);
  }
}

async function ocrFromUpload() {
  const file = document.getElementById("uploadFile").files?.[0];
  if (!file) { showEl("uploadWarn","Please choose a PDF or image file first."); return; }
  hideEl("uploadWarn");
  const isPDF = file.type==="application/pdf"||file.name.toLowerCase().endsWith(".pdf");
  try {
    setSpinner(true,"Running OCR‚Ä¶");
    document.getElementById("extractedText").value = (await (isPDF ? ocrPdfFile(file,3) : ocrImageFile(file))).trim();
    setSpinner(false,"OCR complete ‚úì");
    parseFromExtracted();
  } catch(err) {
    console.error(err);
    setSpinner(false,"");
    showEl("uploadWarn","OCR failed. Try a clearer image/PDF, or paste text instead.");
  }
}

async function ocrImageFile(file) {
  const url = URL.createObjectURL(file);
  try {
    const {data} = await Tesseract.recognize(url,"eng",{
      logger:m=>setSpinner(true,`OCR: ${m.status}${m.progress?" "+Math.round(m.progress*100)+"%":""}`)
    });
    return data.text||"";
  } finally { URL.revokeObjectURL(url); }
}

async function ocrPdfFile(file, maxPages=3) {
  pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";
  const pdf = await pdfjsLib.getDocument({data:await file.arrayBuffer()}).promise;
  const pages = Math.min(pdf.numPages, maxPages);
  let text = "";
  for (let p=1;p<=pages;p++) {
    setSpinner(true,`Rendering PDF page ${p}/${pages}‚Ä¶`);
    const page = await pdf.getPage(p);
    const vp = page.getViewport({scale:2});
    const canvas = document.createElement("canvas");
    canvas.width=vp.width; canvas.height=vp.height;
    await page.render({canvasContext:canvas.getContext("2d"),viewport:vp}).promise;
    setSpinner(true,`OCR page ${p}/${pages}‚Ä¶`);
    const {data} = await Tesseract.recognize(canvas.toDataURL("image/png"),"eng",{
      logger:m=>setSpinner(true,`OCR page ${p}: ${m.status}${m.progress?" "+Math.round(m.progress*100)+"%":""}`)
    });
    text += "\n"+(data.text||"");
  }
  return text;
}

/* ===================================================
   IMPORT PREVIEW + SAVE
=================================================== */
function renderImportPreview(list, warnings) {
  const area = document.getElementById("previewArea");
  area.innerHTML = "";

  if (warnings.length) {
    const w = document.createElement("div");
    w.className = "warn-msg show";
    w.style.cssText="margin-bottom:10px;white-space:pre-wrap;";
    w.textContent = "Warnings:\n‚Ä¢ "+warnings.slice(0,18).join("\n‚Ä¢ ")+(warnings.length>18?"\n‚Ä¢ ‚Ä¶":"");
    area.appendChild(w);
  }
  if (!list.length) return;

  const wrap = document.createElement("div");
  wrap.innerHTML = `
    <div class="section-heading" style="margin-top:12px;">
      <span class="section-label">Preview (editable)</span>
      <span style="font-size:11px;color:var(--ink-3);">Edit before saving. Times must be HH:MM (24h).</span>
    </div>
    <div class="table-wrap">
    <table class="import-preview-table">
      <thead><tr>
        <th>#</th><th>Date</th><th>Employee</th><th>Location</th>
        <th>Start</th><th>End</th><th>Break(m)</th><th class="td-right">Hrs</th><th class="td-right">Keep</th>
      </tr></thead>
      <tbody id="importTbody"></tbody>
    </table>
    </div>`;
  area.appendChild(wrap);

  const tbody = document.getElementById("importTbody");
  list.forEach((s,idx)=>{
    const hrs = (s.date&&s.start&&s.end) ? round2(calcHours(s.start,s.end,s.breakMin||0)).toFixed(2):"0.00";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="td-mono">${idx+1}</td>
      <td><input data-k="date" data-i="${idx}" class="td-mono" value="${escapeAttr(s.date)}" placeholder="YYYY-MM-DD" style="width:120px;"></td>
      <td><input data-k="employee" data-i="${idx}" value="${escapeAttr(s.employee)}" style="width:100px;"></td>
      <td><input data-k="location" data-i="${idx}" value="${escapeAttr(s.location||"")}" style="width:90px;"></td>
      <td><input data-k="start" data-i="${idx}" class="td-mono" value="${escapeAttr(s.start)}" placeholder="HH:MM" style="width:72px;"></td>
      <td><input data-k="end" data-i="${idx}" class="td-mono" value="${escapeAttr(s.end)}" placeholder="HH:MM" style="width:72px;"></td>
      <td><input data-k="breakMin" data-i="${idx}" type="number" min="0" step="5" value="${s.breakMin||0}" style="width:56px;"></td>
      <td class="td-right td-mono" id="impH_${idx}">${hrs}</td>
      <td class="td-right"><input data-k="keep" data-i="${idx}" type="checkbox" checked></td>`;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("input",()=>{
      const i=Number(inp.getAttribute("data-i")), k=inp.getAttribute("data-k");
      if(k==="keep") return;
      importDraft[i][k] = k==="breakMin" ? Number(inp.value||0) : inp.value;
      const s=importDraft[i], cell=document.getElementById(`impH_${i}`);
      if(cell) cell.textContent=(s.date&&s.start&&s.end)?round2(calcHours(s.start,s.end,s.breakMin||0)).toFixed(2):"0.00";
    });
  });
}

function saveImported() {
  hideEl("modalMsg");
  if (!importDraft?.length) { showEl("modalMsg","No parsed shifts to save."); return; }

  const tbody = document.getElementById("importTbody");
  const keeps = tbody ? Array.from(tbody.querySelectorAll('input[data-k="keep"]')) : [];
  const today = todayISO();
  let saved=0, skippedFuture=0, skippedInvalid=0;

  for (let idx=0; idx<importDraft.length; idx++) {
    const s = importDraft[idx];
    const chk = keeps.find(x=>Number(x.getAttribute("data-i"))===idx);
    if (chk && !chk.checked) continue;

    const date=(s.date||"").trim(), employee=(s.employee||"").trim();
    const start=(s.start||"").trim(), end=(s.end||"").trim();
    const breakMin=Number(s.breakMin||0);
    const location=(s.location||document.getElementById("location").value||"").trim();

    if (!date||!employee||!start||!end) { skippedInvalid++; continue; }
    if (date>today) { skippedFuture++; continue; }
    const v = validateShift(start,end,breakMin);
    if (!v.ok) { skippedInvalid++; continue; }

    shifts.push({ id:makeId(), date, location, employee, start, end, breakMin,
      notes:s.notes||"", hours:round2(calcHours(start,end,breakMin)) });
    saved++;
  }

  save(); render();

  if (!saved) {
    showEl("modalMsg","Nothing saved ‚Äî check date/time fields in preview.");
    return;
  }

  const msg = `Saved ${saved} shift(s).`
    +(skippedFuture?` Skipped future: ${skippedFuture}.`:"")
    +(skippedInvalid?` Skipped invalid: ${skippedInvalid}.`:"");
  toast(msg,"success",4000);
  setTimeout(()=>closeImport(),200);
}

/* ===================================================
   DETECT MONTH/YEAR
=================================================== */
function detectMonthYearFromText(text) {
  const monthMap = {january:1,jan:1,february:2,feb:2,march:3,mar:3,april:4,apr:4,
    may:5,june:6,jun:6,july:7,jul:7,august:8,aug:8,september:9,sept:9,sep:9,
    october:10,oct:10,november:11,nov:11,december:12,dec:12};
  const monthNames=["","January","February","March","April","May","June","July",
    "August","September","October","November","December"];
  const sample=text.split(/\r?\n/).slice(0,8).join(" ").toLowerCase();
  const m=sample.match(/\b(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:t|tember)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\b[^0-9]{0,12}\b(20\d{2}|19\d{2})\b/);
  if (!m) return null;
  const month=monthMap[m[1]]||monthMap[m[1].slice(0,3)]||null;
  if (!month) return null;
  const year=Number(m[2]);
  let locationGuess=null;
  const lm=sample.match(/^([a-z][a-z\s'.-]{2,40}?)\s+(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/);
  if (lm) locationGuess=lm[1].trim().replace(/\s+/g," ");
  return {month,year,monthName:monthNames[month],locationGuess};
}

function toISODate(y,m,d) { return `${pad4(y)}-${pad(m)}-${pad(d)}`; }
function pad4(n) { return String(n).padStart(4,"0"); }

/* ===================================================
   PARSE TEXT
=================================================== */
function parseShiftsFromText(text, defaultYear, defaultMonth, defaultLocation) {
  const warnings=[];
  const lines=text.replace(/\t/g," ").replace(/[‚Äì‚Äî]/g,"-").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  let currentDate=null, dayDefaultAp=null;
  const parsed=[];

  for (let i=0;i<lines.length;i++) {
    const line=lines[i];
    if (/^total\s*hours?\b/i.test(line)||/^hours?\b/i.test(line)) continue;
    const det=detectMonthYearFromText(line);
    if (det) { defaultMonth=det.month; defaultYear=det.year; if(det.locationGuess&&!defaultLocation) defaultLocation=det.locationGuess; continue; }
    const dateOnly=line.match(/^(\d{1,2})\s*[\/\-]\s*(\d{1,2})(?:\s*[\/\-]\s*(\d{2,4}))?$/);
    if (dateOnly) {
      const day=Number(dateOnly[1]), month=Number(dateOnly[2])||defaultMonth;
      let year=dateOnly[3]?Number(dateOnly[3]):defaultYear;
      if (year<100) year=2000+year;
      currentDate=toISODate(year,month,day); dayDefaultAp=null; continue;
    }
    const extracted=extractShiftsFromLine(line,currentDate,defaultYear,defaultMonth,defaultLocation,dayDefaultAp);
    parsed.push(...extracted.items);
    extracted.warnings.forEach(w=>warnings.push(`Line ${i+1}: ${w}`));
    if (extracted.dayDefaultAp) dayDefaultAp=extracted.dayDefaultAp;
  }
  parsed.forEach((s,idx)=>{ if(!s.date) warnings.push(`Row ${idx+1}: Missing date ‚Äî add a date line like "1/2" before shifts.`); });
  return {shifts:parsed, warnings};
}

function extractShiftsFromLine(line, currentDate, defaultYear, defaultMonth, defaultLocation, dayDefaultAp) {
  const warnings=[], items=[];
  const clean=line.replace(/\bHours?\b\s*\d+(\.\d+)?/gi,"").trim();
  if (!clean) return {items,warnings,dayDefaultAp};
  if (detectMonthYearFromText(clean)) return {items,warnings,dayDefaultAp};
  const parts=clean.split(/[;|]/).map(s=>s.trim()).filter(Boolean);

  for (const part of parts) {
    const mm=part.match(/^([A-Za-z][A-Za-z\s'.-]{1,40}?)\s+(.+)$/);
    if (!mm) continue;
    const name=mm[1].trim(), rest=mm[2].trim();
    let startRaw="", endRaw="";
    const range=rest.match(/(.+?)\s*(?:\bto\b|-)\s*(.+)$/i);
    if (range) { startRaw=range[1].trim(); endRaw=range[2].trim(); }
    else {
      const tt=rest.match(/\b(\d{1,2}:\d{2}\s*(?:am|pm)?|\d{1,2}\s*(?:am|pm))\b/gi);
      if (tt&&tt.length>=2) { startRaw=tt[0]; endRaw=tt[1]; } else continue;
    }
    let date=currentDate;
    if (!date) {
      const dm=part.match(/(\d{1,2})\s*[\/\-]\s*(\d{1,2})(?:\s*[\/\-]\s*(\d{2,4}))?/);
      if (dm) { const day=Number(dm[1]),month=Number(dm[2])||defaultMonth; let year=dm[3]?Number(dm[3]):defaultYear; if(year<100)year=2000+year; date=toISODate(year,month,day); }
    }
    const t1=parseTimeToHHMM(startRaw,null,dayDefaultAp);
    const t2=parseTimeToHHMM(endRaw,t1,dayDefaultAp);
    if (t1.ok&&t1.hasAmPm&&t1.ap) dayDefaultAp=t1.ap;
    if (!t1.ok||!t2.ok) warnings.push(`Could not parse time for "${name}" in: "${part}". Please edit manually.`);
    if (t1.ambiguous) warnings.push(`Ambiguous start time "${startRaw}" for "${name}".`);
    if (t2.ambiguous) warnings.push(`Ambiguous end time "${endRaw}" for "${name}".`);
    items.push({date:date||"",location:defaultLocation||"",employee:name,start:t1.ok?t1.hhmm:"",end:t2.ok?t2.hhmm:"",breakMin:0,notes:""});
  }
  return {items,warnings,dayDefaultAp};
}

function parseTimeToHHMM(raw, contextStart, defaultAp) {
  if (!raw) return {ok:false,hhmm:"",ambiguous:false,hasAmPm:false,ap:null,hour24:null};
  const s=raw.toLowerCase().replace(/\./g,"").replace(/\s+/g,"").replace(/hrs?|hours?/g,"").replace(/[^0-9apm:]/g,"");
  const m=s.match(/^(\d{1,2})(?::(\d{2}))?(am|pm)?$/);
  if (!m) return {ok:false,hhmm:"",ambiguous:false,hasAmPm:false,ap:null,hour24:null};
  let hh=Number(m[1]), mm2=Number(m[2]||"0"), ap=m[3]||null;
  if (mm2<0||mm2>59||hh<0||hh>24) return {ok:false,hhmm:"",ambiguous:false,hasAmPm:!!ap,ap,hour24:null};
  let ambiguous=false, hasAmPm=!!ap;
  function out(h24,ua=null) { return {ok:true,hhmm:`${pad(h24)}:${pad(mm2)}`,ambiguous,hasAmPm:hasAmPm||!!ua,ap:ua||ap,hour24:h24}; }
  if (ap) { let h24=hh; if(h24===12)h24=0; if(ap==="pm")h24+=12; return out(h24,ap); }
  if (hh>=13&&hh<=24) return out(hh===24?0:hh,null);
  ambiguous=true;
  if (contextStart&&contextStart.ok&&contextStart.hasAmPm&&contextStart.ap==="pm") {
    ambiguous=false; return hh===12?out(0,"pm"):out(hh+12,"pm");
  }
  if (defaultAp==="pm") { ambiguous=false; return hh===12?out(0,"pm"):out(hh+12,"pm"); }
  return out(hh,null);
}

/* ===================================================
   UI HELPERS
=================================================== */
function showEl(id, msg, isOk=false) {
  const el=document.getElementById(id); if(!el)return;
  el.className=isOk?"ok-msg show":"warn-msg show";
  if(msg!==undefined) el.textContent=msg;
}
function hideEl(id) {
  const el=document.getElementById(id); if(!el)return;
  el.classList.remove("show");
}
function setSpinner(show, msg) {
  const el=document.getElementById("ocrStatus"); if(!el)return;
  el.className=show?"ocr-status show":"ocr-status";
  const txt=document.getElementById("ocrStatusText"); if(txt) txt.textContent=msg||"";
}
function makeId() { return crypto.randomUUID?.()??("id_"+Math.random().toString(16).slice(2)+Date.now().toString(16)); }
function escapeHtml(s) { return String(s??"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c])); }
function escapeAttr(s) { return String(s??"").replace(/"/g,"&quot;"); }

/* ===================================================
   INIT
=================================================== */
(function init() {
  applyTheme(getSavedTheme());
  const today=todayISO();
  const di=document.getElementById("selectedDate");
  di.max=today; di.value=today;
  document.getElementById("defaultYear").value=today.split("-")[0];
  document.getElementById("defaultMonth").value=String(Number(today.split("-")[1]));
  ["startTime","endTime","breakMin"].forEach(id=>document.getElementById(id).addEventListener("input",updatePreview));
  di.addEventListener("change",()=>{
    if(isFutureDate(di.value)){ showDateMsg(true); return; }
    showDateMsg(false); resetAddBtn(); render();
  });
  updatePreview(); render();
})();
</script>
</body>
</html>
